<!doctype html>
<html lang="pt-br">
  <head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tutorial básico de stable-diffusion.cpp</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
<link href="/css/blog.css" rel="stylesheet">
<link href="/css/tango.css" rel="stylesheet">
</head>

  
  <body>
  <div class="container">
    <header class="d-flex flex-wrap justify-content-center py-3 mb-2 border-bottom">
	<a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
	<span class="fs-4">A palavra de Haroldo Watson</span>
      </a>

      <ul class="nav nav-pills">
		<li class="nav-item">
		<a href="/" class="nav-link" >
			Home
		</a></li>
		<li class="nav-item">
		<a href="/recomendacao/" class="nav-link" >
			Recomendados
		</a></li>
	      </ul>
      <div>
      </div>
    </header>
    <blockquote class="citacoes">Citação sábia</blockquote>
</div>
  <div class="container">
    <div class="row">

        <div class="col-md-8">
            <article class="postagem">
                <header class="row mb-3">
                    <div class="col">

                        <h2>Tutorial básico de stable-diffusion.cpp</h2>

                                                    <time>22/08/2025</time>
                        
                                                    <img src="/img/stable-diffusion-cpp-tutorial-result.jpg" />
                                            </div>
                </header>

                <p>Ensinarei aqui como usar o <a href="https://github.com/leejet/stable-diffusion.cpp">stable-diffusion.cpp</a> para gerar imagens de IA generativa por linha de comando.</p>

<h2>Introdução</h2>

<p>Requisitos:
- Conhecimento em Linux, Bash e compilação de programas com C++ e CUDA.
- Um computador com 8GB de RAM e uma GPU NVIDIA com pelo menos 4GB de VRAM.
- Linux instalado, com os drivers da NVIDIA e CUDA.
- Ferramentas de desenvolvimento: git, g++, make, cmake, etc.</p>

<p>Os comandos desse tutorial foram testados em uma máquina com Fedora 42 e uma GPU GeForce RTX 2050.
Eu vou supor que o leitor não entende nada de IA generativa, mas que tem uma base sólida em computação.</p>

<h2>Baixando um modelo</h2>

<p>O site <a href="https://civitai.com">CivitAI</a> é focado em modelos generativos. O leitor pode navegar lá e escolher um de sua preferência.
Escolher o modelo não é uma tarefa tão simples quanto parece para um iniciante, por causa da torrente
de informações desconexas, rótulos estranhos, e opções indistinguíveis. É assim mesmo.</p>

<p>Para esse tutorial, será utilizado o modelo <a href="https://civitai.com/models/827184?modelVersionId=1490781">WAI-NSFW-illustrious-SDXL, versão 12</a>.
É um modelo destinado a geração de imagens no estilo anime, gratuito, sem censura, baseado no modelo Illustrious.
Na página dele do CivitAI, há um link para download um pouco escondido, logo abaixo da tabela de detalhes do modelo.
O leitor pode então baixar o arquivo <em>waiNSFWIllustrious_v120.safetensors</em>, de quase 6,5GB.</p>

<p>Baseado no que é dito na página do modelo, pode-se usar as seguintes opções recomendadas:</p>

<pre><code class="language-bash">MODEL_OPTS="--steps 30 --cfg-scale 6.0 --sampling-method euler"
MODEL_POSPROMPT="masterpiece,best quality,amazing quality,"
MODEL_NEGPROMPT="bad quality,worst quality,worst detail,sketch,censor,"

</code></pre>

<p>O significado dessas opções foge do escopo desse tutorial, mas é importante entender que todo modelo tem suas opções específicas
e que elas podem ser encaixadas em argumentos do programa.</p>

<h2>Compilando o programa</h2>

<p>As instruções oficiais para compilação estão na página do github do stable-diffusion.cpp. 
Vou transcrever as instruções da versão atual aqui.</p>

<pre><code class="language-bash">#baixa o código
git clone --recursive https://github.com/leejet/stable-diffusion.cpp
cd stable-diffusion.cpp

#modifique para sua configuração de cuda
CUDA=...
PATH=$PATH:$CUDA/bin
LD_LIBRARY_PATH=$CUDA/lib64

#compila
mkdir build
cd build
cmake .. -DSD_CUDA=ON
cmake --build . --config Release

SD=$PWD/bin/sd
</code></pre>

<p>Daqui pra frente, vou supor que a variável <code>$SD</code> diz o caminho absoluto do binário sd.</p>

<h2>Lidando com poucos recursos</h2>

<p>É perfeitamente possível gerar imagens usando apenas CPU. Isso significa aguardar 20min até 45min pra ver um resultado pronto.
Eu não irei ensinar como fazer isso aqui, mas digo que é um bom exercício de paciência.</p>

<p>Se você tiver uma GPU com 8GB ou mais de memória, o modelo deve caber inteiro na placa e nenhum outro arquivo ou configuração especial é necessária.</p>

<p>Mas se você, como eu, tiver apenas à disposição uma GPU de 4GB, então você precisa quantizar o modelo, ou seja, reduzir o tamanho (e qualidade) do 
arquivo para permitir que pelo menos uma parte dele seja alocada na GPU.
Além disso, será preciso passar alguns argumentos especiais para o programa limitar quais partes do modelo ficam na GPU.</p>

<p>O código a seguir mostra como fazer quantização do arquivo baixado para <em>q4_K</em>:</p>

<pre><code class="language-bash">GGUF=waiNSFWIllustrious_v120_q4_k.gguf
$SD -M convert -m waiNSFWIllustrious_v120.safetensors -o $GGUF  -v --type q4_K
MODEL=$PWD/$GGUF
</code></pre>

<p>Daqui pra frente irei supor que a variável <code>$MODEL</code> tem o filename absoluto do modelo, seja ele safetensors ou gguf.
As seguintes opções dizem para rodar algumas partes do modelo em CPU, e não em GPU:</p>

<pre><code class="language-bash">PERF_OPTIONS="--vae-on-cpu --clip-on-cpu --control-net-cpu"
#ajuste para o número de threads de cpu da sua máquina
THREADS=8
</code></pre>

<p>Essas opções causam uma penalidade de performance, porque rodar em CPU é mais lento do que em GPU.
Sem elas, no entanto, o programa irá falhar ao rodar com esse modelo em uma GPU com 4GB.</p>

<h2>Gerando uma imagem</h2>

<p>Se tudo deu certo até aqui, você já deverá ser capaz de gerar imagens.</p>

<p>O código a seguir irá gerar a imagem de abertura desse tutorial:</p>

<pre><code class="language-bash">PROMPT="Happy high school girl blushes while eating a colorful icecream."
OUTPUT="{{page.img}}"
$SD -m "$MODEL" $MODEL_OPTS -o "$OUTPUT" -H 1024 -W 1024 --seed 69 -p "$PROMPT $MODEL_POSPROMPT" -n "$MODEL_NEGPROMPT"  -t $THREADS  $PERF_OPTIONS
</code></pre>

<p>O significado dos argumentos é: usar o modelo com as opções del para gerar uma imagem com o nome passado, de altura 1024, largura 1024, semente aleatória 69 (altere para ter resultados diferentes),
com o prompt textual e prompt negativo passados, usando o número de threads passadas e as demais opções já comentadas.</p>
            </article>
        </div>

        <div class="col-md-4">
            <div class="p-4">
<h4>Postagens recentes</h4>
<ul class="list-unstyled">
 	<li class="py-3 border-top " >
		<a class=" text-decoration-none"  href="https://haroldowtsilva.github.io/2025/06/21/inauguracao">
		<div class="col-lg-8"> 
			<h6 class="mb-0"> Inauguração </h6> 
			<small class="text-body-secondary">21/06/2025</small> 
		</div>	
		</a>
	</li>
	<li class="py-3 border-top " >
		<a class=" text-decoration-none"  href="https://haroldowtsilva.github.io/2025/07/03/criando-um-blog-com-jekyll">
		<div class="col-lg-8"> 
			<h6 class="mb-0"> Criando um blog com Jekyll </h6> 
			<small class="text-body-secondary">03/07/2025</small> 
		</div>	
		</a>
	</li>
	<li class="py-3 border-top " >
		<a class=" text-decoration-none"  href="https://haroldowtsilva.github.io/2025/08/17/svmlm">
		<div class="col-lg-8"> 
			<h6 class="mb-0"> SVMLM </h6> 
			<small class="text-body-secondary">17/08/2025</small> 
		</div>	
		</a>
	</li>
	<li class="py-3 border-top " >
		<a class=" text-decoration-none"  href="https://haroldowtsilva.github.io/2025/08/22/tutorial-basico-de-stable-diffusion.cpp">
		<div class="col-lg-8"> 
			<h6 class="mb-0"> Tutorial básico de stable-diffusion.cpp </h6> 
			<small class="text-body-secondary">22/08/2025</small> 
		</div>	
		</a>
	</li>
	<li class="py-3 border-top " >
		<a class=" text-decoration-none"  href="https://haroldowtsilva.github.io/2025/09/11/embedding-tipografico">
		<div class="col-lg-8"> 
			<h6 class="mb-0"> Embedding tipográfico </h6> 
			<small class="text-body-secondary">11/09/2025</small> 
		</div>	
		</a>
	</li>
	<li class="py-3 border-top " >
		<a class=" text-decoration-none"  href="https://haroldowtsilva.github.io/2025/10/09/tutorial-de-compressao-de-video-com-ffmpeg">
		<div class="col-lg-8"> 
			<h6 class="mb-0"> Tutorial de compressão de vídeo com FFMPEG </h6> 
			<small class="text-body-secondary">09/10/2025</small> 
		</div>	
		</a>
	</li>
	<li class="py-3 border-top " >
		<a class=" text-decoration-none"  href="https://haroldowtsilva.github.io/2025/10/19/acessando-o-irc-com-weechat">
		<div class="col-lg-8"> 
			<h6 class="mb-0"> Acessando o IRC com Weechat </h6> 
			<small class="text-body-secondary">19/10/2025</small> 
		</div>	
		</a>
	</li>
</ul>
</div>

<div class="p-4 mb-3 bg-body-tertiary"> 
<a href="https://github.com/HaroldoWTSilva" target="_blank" rel="noopener noreferrer" class="avatar d-inline-block text-decoration-none">
    <img 
        src="https://github.com/HaroldoWTSilva.png" 
        alt="Foto de perfil do Haroldo"
        width="160"
        height="160"
        class="rounded-circle shadow transition-all"
        style="object-fit: cover; border: 3px solid #f8f9fa;"
    >
</a>
	<h4 class="fst-italic">Sobre</h4> 
	<p class="mb-0">Um blog sobre computação, multimídia, opiniões perturbadoras e dominação global</p>
</div>

        </div>

    </div>
</div>
  <div class="container">
  <footer class="pt-5 my-5 text-body-secondary border-top">
    A palavra de Haroldo Watson
  </footer>
</div>
<script data-goatcounter="https://haroldowtsilva.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
<script src="/js/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<script src="/js/blog.js"></script>
  </body>
</html>

